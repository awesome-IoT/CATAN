<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>DICE: Disaster and Incident Communications nEtwork Visualization</title>
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
      #panel {
        position: absolute;
        top: 5px;
        left: 50%;
        margin-left: -180px;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCM1x3VgMzI2rIpVFHk9VGduhoYVcYmGvM"></script>
    <script src="jquery-1.11.1.min.js"></script>
    <script>
// This page visualizes CATAN datapoints for nodes, people, bulletins, etc. onto a map.

var REFRESH_INTERVAL = 10000; //ms
var map;

var node_markers = [];
var people_markers = [];
var bulletin_markers = [];

var node_icon = 'http://www.google.com/intl/en_us/mapfiles/ms/micons/blue-dot.png'
var people_icon = 'http://www.google.com/intl/en_us/mapfiles/ms/micons/green-dot.png'
var bulletin_icon = 'http://www.google.com/intl/en_us/mapfiles/ms/micons/yellow-dot.png'


function initialize() {
  console.log("Initializing");

  // TODO intelligent centering of map based on our data points
  var myLatlng = new google.maps.LatLng(42.359048, -71.093599);
  var mapOptions = {
    zoom: 15,
    center: myLatlng
  };
  
  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

  // TODO load things from the database
  setInterval(function () {$.ajax(
  {
    url : '/cgi-bin/getMapData.cgi',
    type: "GET",
    success:function(data, textStatus, jqXHR)
    {
      // load nodes
      $.each(data.nodes, function(index)
      {
        var node_info = data.nodes[index];
        var loc = new google.maps.LatLng(node_info.gps_latitude, node_info.gps_longitude);
        var nodeObj = {
          'location':loc,
          'contentString':'<div>'+
          '<h1 class="firstHeading">Node</h1>'+
          '<div id="person1bodyContent">'+
          '<p><b>Node ' + node_info.node_id + '</b>, Test test.</p>'+
          '</div>'+
          '</div>',
          'title':'Node ' + node_info.node_id
        };

        addNodeMarker(nodeObj);

      });      

      // load people
      $.each(data.people, function(index)
      {
        var person = data.people[index];
        var loc = new google.maps.LatLng(person.location_gps_latitude, person.location_gps_longitude);
        var history = '<p><b>History: </b>';
        for (var i = 0; i < person.updates.length; i++)
	{
          update = person.updates[i];
	  history += '<br>&nbsp&nbsp<b>Update ' + i + '</b>';

	  history += '<br>&nbsp&nbsp&nbsp&nbsp<u>timestamp:</u> ' + new Date(update.timestamp);
			    
          if (typeof update.location_gps_latitude != 'undefined') {
	    history += '<br>&nbsp&nbsp&nbsp&nbsp<u>gps_lat:</u> ' + update.location_gps_latitude;
	  }
          if (typeof update.location_gps_longitude != 'undefined') {
	    history += '<br>&nbsp&nbsp&nbsp&nbsp<u>gps_long:</u> ' + update.location_gps_longitude;
	  }
          if (typeof update.status != 'undefined') {
	    history += '<br>&nbsp&nbsp&nbsp&nbsp<u>status:</u> ' + update.status;
	  }
          if (typeof update.status_location != 'undefined') {
	    history += '<br>&nbsp&nbsp&nbsp&nbsp<u>status_location:</u> ' + update.status_location;
	  }
	  history += '<br></p>'
	}
        var personObj = {
          'location':loc,
          'contentString':'<div>'+
          '<h1 class="firstHeading">' + person.name_given + ' ' + person.name_family + '</h1>'+
          '<div id="person1bodyContent">'+
          '<p><b>ID:</b> ' + person.origin_node_id + ':'+ person.person_id + '</p>'+
          '<p><b>Age:</b> ' + person.age + ', Sex: ' + person.sex + '</p>'+
	  '<p><b>Last Update:</b> ' + new Date(person.latest_timestamp*1000) + '</p>'+
          '<p><b>Status:</b> ' + person.status + '</p><p><b>Status Location:</b> ' + person.status_location + '</p>'+
	  history +
          '</div>'+
          '</div>',
          'title':'Person'
        };

        addPeopleMarker(personObj);

      });      

      // TODO other items


    },
    error: function(jqXHR, textStatus, errorThrown)
    {
      //do nothing for now
    }
  })
  }, REFRESH_INTERVAL);



var loc6 = new google.maps.LatLng(42.356844, -71.098681);

var Bulletin1 = {
  'location':loc6,
  'contentString':'<div id="bulletin1content">'+
      '<div id="bulletin1siteNotice">'+
      '</div>'+
      '<h1 id="bulletin1firstHeading" class="firstHeading">Bulletin</h1>'+
      '<div id="bulletin1bodyContent">'+
      '<p><b>Blah blah</b>, Blah blah.</p>'+
      '</div>'+
      '</div>',
  'title':'Bulletin'
};

addBulletinMarker(Bulletin1);
}


// Listeners that add or remove classes of nodes  

// Add a Node marker to the map and push to the array.
function addNodeMarker(markerInfo) {

   var infowindow = new google.maps.InfoWindow({
     content: markerInfo.contentString,
     maxWidth: 200
  });

  var marker = new google.maps.Marker({
    position: markerInfo.location,
    map: null,
    icon: node_icon,
    title: markerInfo.title
  });

  google.maps.event.addListener(marker, 'mouseover', function() {
    infowindow.open(map,marker);
  });

  google.maps.event.addListener(marker, 'mouseout', function() {
    infowindow.close();
  });

  node_markers.push(marker);
}

// Add a People marker to the map and push to the array.
function addPeopleMarker(markerInfo) {

   var infowindow = new google.maps.InfoWindow({
     content: markerInfo.contentString,
     maxWidth: 200
  });

  var marker = new google.maps.Marker({
    position: markerInfo.location,
    map: null,
    icon: people_icon,
    title: markerInfo.title
  });

  google.maps.event.addListener(marker, 'mouseover', function() {
    infowindow.open(map,marker);
  });

  google.maps.event.addListener(marker, 'mouseout', function() {
    infowindow.close();
  });

  people_markers.push(marker);
}


// Add a Bulletin marker to the map and push to the array.
function addBulletinMarker(markerInfo) {

   var infowindow = new google.maps.InfoWindow({
     content: markerInfo.contentString,
     maxWidth: 200
  });

  var marker = new google.maps.Marker({
    position: markerInfo.location,
    map: null,
    icon: bulletin_icon,
    title: markerInfo.title
  });

  google.maps.event.addListener(marker, 'mouseover', function() {
    infowindow.open(map,marker);
  });

  google.maps.event.addListener(marker, 'mouseout', function() {
    infowindow.close();
  });

  bulletin_markers.push(marker);
}


// Sets the map on all Node markers
function setAllNodes(map) {
  for (var i = 0; i < node_markers.length; i++) {
    node_markers[i].setMap(map);
  }
}

// Sets the map on all People markers
function setAllPeople(map) {
  for (var i = 0; i < people_markers.length; i++) {
    people_markers[i].setMap(map);
  }
}

// Sets the map on all Bulletin markers
function setAllBulletins(map) {
  for (var i = 0; i < bulletin_markers.length; i++) {
    bulletin_markers[i].setMap(map);
  }
}

// Handler for when the Node checkbox is clicked
function nodeCheckHandler(chkbox) {
  if (chkbox.checked) {
    setAllNodes(map);
  }
  else {
    setAllNodes(null);
  }
}

// Handler for when the People checkbox is clicked
function peopleCheckHandler(chkbox) {
  if (chkbox.checked) {
    setAllPeople(map);
  }
  else {
    setAllPeople(null);
  }
}

// Handler for when the Bulletin checkbox is clicked
function bulletinsCheckHandler(chkbox) {
  if (chkbox.checked) {
    setAllBulletins(map);
  }
  else {
    setAllBulletins(null);
  }
}


google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
    <div id="panel">
      <center>
      <input type="checkbox" id="nodes" value="nodes" onclick="nodeCheckHandler(this)">Nodes
      <input type="checkbox" id="people" value="people" onclick="peopleCheckHandler(this)">People
      <input type="checkbox" id="bulletins" value="bulletins" onclick="bulletinsCheckHandler(this)">Bulletins
      </center>
    </div>
    <div id="map-canvas"></div>
  </body>
</html>
